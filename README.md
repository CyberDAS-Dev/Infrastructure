# Infrastructure
Серверная инфраструктура проекта CyberDAS, включающая систему мониторинга, логгирования и маршрутизации запросов.

## Что это?

Это набор конфигов и `docker-compose` файлов, настраивающих окружение на сервере проекта CyberDAS. Всё окружение состоит из набора обособленных контейнеров, выполняющих свою задачу. Если вы никогда не сталкивались с `docker` и вам не знакомо понятие контейнера, рекомендую пройти по этой ссылке: https://docs.docker.com/get-started/.

## Маршрутизация

В нашей инфраструктуре есть только один контейнер,'смотрящий' в публичную сеть и направляющий запросы к контейнерам - [traefik](https://github.com/traefik/traefik). 

Такое решение может показаться странным, ведь если упадет этот контейнер - то сразу теряется доступ ко всей остальной системе. Ну да. Но вариант поставить один глобальный `Nginx` был бы ни чем не лучше. 

Но у `traefik` есть один огромный плюс: добавление новых контейнеров производится без дописывания глобального конфига. Если разработчик хочет опубликовать новый сервис, он просто присоединяет свой контейнер к определенной `Docker network` (в нашем случае она называется "proxy") и объявляет в одной строчке о том, что ему нужен доступ в веб. Вуаля! `Docker` делает всю остальную работу. 

На примере (фрагмент `docker-compose` файла абстрактного сервиса):
```yaml
services:
  backend:
    build: backend
    expose:
      - 5000
    networks:
      - proxy
    labels:
      - traefik.enable=true

networks:
  proxy:
    external: true
```

Что при этом произойдет? 
1. Приложение, которое работает в контейнере `backend` на 5000-ом порту окажется доступным по адресу https://backend.cyberdas.net
2. Все HTTP запросы к контейнеру автоматически перенаправляются на протокол HTTPS
3. На этот поддомен автоматически оформится SSL-сертификат и будет обновляться, до тех пор пока этот контейнер существует
4. В логах доступа автоматически появится новая категория, позволяющая анализировать запросы только к этому контейнеру (ура, можно не вести своих access логов!)


Пара важных моментов:
1. При отсутствии ключа `TRAEFIK_REAL_CERTS` в окружении, `traefik` будет обращаться к стейджинг АПИ LetsEncrypt (отлично подходит для тестов!). Если этот ключ есть в окружении, то `traefik` будет пытаться получить настоящие сертификаты.
2. Раздача имен сервисам (`backend.cyberdas.net` из примера выше) происходит нехитрым образом: из полного имени контейнера, состоящего из имени самого контейнера и имени проекта, отрываемся имя проекта. То, что осталось - создается как сабдомен. **Следите за коллизиями и именуйте семантически!** Кстати, не все сервисы должны стоять на сабдоменах, и это поведение полностью кастомизируется. По всем вопросам обращайтесь к документации: https://doc.traefik.io/
3. При локальной разработке получить доступ к сервисам можно обращаясь на локалхост; например, `traefik.localhost`.
